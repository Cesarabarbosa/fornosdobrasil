<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fornos do Brasil – Mapa</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<style>
  html, body, #map { height: 100%; margin: 0; }
  .topbar {
    position: fixed; inset: 8px 8px auto 8px;
    background: rgba(255,255,255,.95); border-radius: 10px; padding: 8px 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,.1); z-index: 9999; font-family: system-ui, sans-serif;
  }
  .topbar input { padding: 6px 8px; min-width: 260px; }
  .topbar button { padding: 6px 10px; margin-left: 6px; }
  .leaflet-popup-content p { margin: .25em 0; }
</style>
</head>
<body>
<div id="map"></div>
<div class="topbar">
  <strong>Fornos do Brasil</strong>
  <input id="q" type="search" placeholder="Buscar por nome/cidade/descrição…">
  <button id="btn">Buscar</button>
  <button id="clr">Limpar</button>
  <span id="count" style="margin-left:10px; opacity:.7"></span>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const map = L.map('map').setView([-14.235,-51.925], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

const cluster = L.markerClusterGroup();
let markers = [];
let data;

fetch('fornos_brasil.geojson')
  .then(r => r.json())
  .then(geo => {
    data = geo.features;
    data.forEach(f => {
      if (f.geometry.type === "Point") {
        const [lng, lat] = f.geometry.coordinates;
        const props = f.properties || {}
        const title = props.name || "Sem nome";
        const desc = props.description || "";
        const extPairs = Object.entries(props).filter(([k]) => !["name","description","altitude"].includes(k));
        let extHtml = "";
        if (extPairs.length) {
          extHtml = "<hr><b>Dados:</b><br>" + extPairs.map(([k,v]) => `<div><b>${k}:</b> ${v}</div>`).join("");
        }
        const popup = `<div><b>${title}</b><br>${desc}${extHtml}</div>`;
        const m = L.marker([lat, lng]).bindPopup(popup);
        markers.push({ marker: m, props, lat, lng });
        cluster.addLayer(m);
      }
    });
    map.addLayer(cluster);
    document.getElementById('count').textContent = `${markers.length} pontos`;
  })
  .catch(err => console.error(err));

function applyFilter() {
  const q = document.getElementById('q').value.trim().toLowerCase();
  cluster.clearLayers();
  let shown = 0;
  if (!q) {
    markers.forEach(m => cluster.addLayer(m.marker));
    shown = markers.length;
  } else {
    markers.forEach(m => {
      const blob = JSON.stringify(m.props).toLowerCase();
      if (blob.includes(q)) { cluster.addLayer(m.marker); shown++; }
    });
  }
  document.getElementById('count').textContent = `${shown} de ${markers.length} pontos`;
  if (shown > 0) {
    const group = L.featureGroup(cluster.getLayers());
    map.fitBounds(group.getBounds().pad(0.2));
  }
}
document.getElementById('btn').addEventListener('click', applyFilter);
document.getElementById('clr').addEventListener('click', () => { document.getElementById('q').value=''; applyFilter(); });
document.getElementById('q').addEventListener('keydown', e => { if (e.key === 'Enter') applyFilter(); });
</script>
</body>
</html>
