<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mapa – Ateliês com Queimas</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: system-ui, sans-serif;
  }
  header {
    background: #111;
    color: #fff;
    padding: 10px;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  header input[type="search"] {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    border: none;
  }
  header button {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  #btnNear { background: #22c55e; color: #111; }
  #btnClear { background: #fff; color: #111; }
  #count { margin-left: 10px; font-size: 0.9em; }
  #map { height: calc(100% - 50px); }
</style>
</head>
<body>
  <header>
    <input id="q" type="search" placeholder="Buscar por nome ou cidade…">
    <button id="btnNear">Perto</button>
    <button id="btnClear">Limpar</button>
    <span id="count"></span>
  </header>
  <div id="map"></div>

<script>
// Carrega mapa base
const map = L.map('map').setView([-14.2, -51.9], 4);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

let DATA = null;
let markers = L.featureGroup().addTo(map);

// Renderiza pontos
function render(fc) {
  markers.clearLayers();
  if (!fc || !fc.features) return;
  const layer = L.geoJSON(fc, {
    onEachFeature: (f, l) => l.bindPopup(`<strong>${f.properties.name}</strong><br>${f.properties.description || ""}`)
  });
  markers.addLayer(layer);
  try { map.fitBounds(markers.getBounds(), { padding:[20,20] }); }
  catch(e) { map.setView([-14.2,-51.9],4); }
  document.getElementById('count').textContent = fc.features.length + " resultado(s)";
}

// Busca
function search(term) {
  if (!term) return DATA;
  const t = term.toLowerCase();
  const feats = DATA.features.filter(f =>
    Object.values(f.properties||{}).some(v => String(v).toLowerCase().includes(t))
  );
  return { type:'FeatureCollection', features: feats };
}

// Perto de mim (50km)
function deg2rad(d){return d*Math.PI/180;}
function haversineKm(a,b){
  const R=6371;
  const dLat=deg2rad(b[1]-a[1]), dLon=deg2rad(b[0]-a[0]);
  const s=Math.sin(dLat/2)**2+Math.cos(deg2rad(a[1]))*Math.cos(deg2rad(b[1]))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(s)));
}
function nearMe(){
  if(!navigator.geolocation) return alert("Geolocalização não suportada");
  navigator.geolocation.getCurrentPosition(pos=>{
    const me=[pos.coords.longitude,pos.coords.latitude];
    const feats=DATA.features.map(f=>({f,d:haversineKm(me,f.geometry.coordinates)})).sort((a,b)=>a.d-b.d);
    const within=feats.filter(x=>x.d<=50).map(x=>x.f);
    render({type:'FeatureCollection',features:within});
    L.circle([me[1],me[0]],{radius:500,color:'#2563eb'}).addTo(map);
  },err=>alert("Não foi possível obter sua localização."));
}

// Eventos UI
document.getElementById('q').addEventListener('input',e=>render(search(e.target.value)));
document.getElementById('btnClear').addEventListener('click',()=>{document.getElementById('q').value="";render(DATA);});
document.getElementById('btnNear').addEventListener('click',nearMe);

// Carrega GeoJSON
fetch('fornos_brasil.geojson').then(r=>r.json()).then(fc=>{
  DATA=fc;
  render(DATA);
});
</script>
</body>
</html>
