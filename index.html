<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FORNOS PARA SERVI√áO DE QUEIMA NO BRASIL </title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --ink:#111; --muted:#57606a; --line:#e5e7eb; --bg:#f8fafc; --card:#fff; --accent:#2563eb;
  }
  @media (prefers-color-scheme: dark){
    :root{ --ink:#eaeef2; --muted:#a9b1ba; --line:#2a2f36; --bg:#0b0f14; --card:#11161c; --accent:#3b82f6; }
  }
  *{box-sizing:border-box}
  body{margin:0; font:16px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); background:var(--bg);}
  header{position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--line);}
  .wrap{max-width:1000px; margin:0 auto; padding:16px;}
  h1{font-size:20px; margin:0 0 8px 0}
  .filters{display:grid; grid-template-columns: 1fr 1fr 2fr auto; gap:8px; align-items:end}
  label{font-size:12px; color:var(--muted)}
  select, input[type="text"], button{ width:100%; padding:10px 12px; border:1px solid var(--line); background:var(--card); color:var(--ink); border-radius:10px; }
  button{cursor:pointer; border-color:var(--accent)}
  main .summary{padding:12px 0; color:var(--muted); font-size:14px}
  .tablewrap{max-height:55vh; overflow:auto; border-radius:12px;}
  table{width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden}
  thead th{position:sticky; top:66px; background:var(--card); text-align:left; padding:10px; border-bottom:1px solid var(--line); font-size:13px; color:var(--muted)}
  tbody td{padding:10px; border-bottom:1px solid var(--line); vertical-align:top; font-size:14px}
  tbody tr:last-child td{border-bottom:none}
  .muted{color:var(--muted); font-size:12px}
  .badgelink{display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; text-decoration:none;}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  footer{color:var(--muted); font-size:12px; padding:24px 0}

  /* Mapa ao final, n√£o tela toda */
  .map-section{max-width:1000px; margin:24px auto; padding:0 16px;}
  .map-card{background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden;}
  .map-ratio{position:relative; width:100%; padding-top:56.25%;} /* 16:9 */
  .map-ratio iframe{position:absolute; inset:0; width:100%; height:100%; border:0;}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Ateli√™s de Cer√¢mica ‚Ä¢ Filtro por Estado e Cidade</h1>
      <div class="filters">
        <div>
          <label for="uf">Estado (UF)</label>
          <select id="uf">
            <option value="">Todos</option>
          </select>
        </div>
        <div>
          <label for="city">Cidade</label>
          <select id="city" disabled>
            <option value="">Todas</option>
          </select>
        </div>
        <div>
          <label for="q">Busca (nome, endere√ßo‚Ä¶)</label>
          <input id="q" type="text" placeholder="Digite para filtrar‚Ä¶" />
        </div>
        <div>
          <button id="clear">Limpar</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="summary" id="summary">Carregando dados‚Ä¶</div>
    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th>Ateli√™</th>
            <th>UF</th>
            <th>Cidade</th>
            <th>Contato</th>
            <th>Queima</th>
            <th>Links</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- linhas renderizadas via JS -->
        </tbody>
      </table>
    </div>
    <footer>
      Dica: padronize <strong>UF</strong> e <strong>Cidade</strong> na planilha para resultados mais precisos.
    </footer>
  </main>

  <section class="map-section">
    <div class="map-card">
      <div class="map-ratio">
        <iframe src="https://www.google.com/maps/d/u/0/embed?mid=1Mhb5gI33KRZn9tJDwZ7uJfjOAFtqmUY&ehbc=2E312F" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </div>
  </section>

<script>
(() => {
  const DATA_URL = 'https://cesarabarbosa.github.io/fornosdobrasil/dados/dados-ateliers.csv';

  const $uf = document.getElementById('uf');
  const $city = document.getElementById('city');
  const $q = document.getElementById('q');
  const $clear = document.getElementById('clear');
  const $tbody = document.getElementById('tbody');
  const $summary = document.getElementById('summary');

  let rows = [];
  let filtered = [];

  // Mapa de nomes -> UF (aceita varia√ß√µes com acento/mai√∫sculas).
  const UF_MAP = {
    "ACRE":"AC","ALAGOAS":"AL","AMAP√Å":"AP","AMAPA":"AP","AMAZONAS":"AM","BAHIA":"BA","CEAR√Å":"CE","CEARA":"CE",
    "DISTRITO FEDERAL":"DF","ESP√çRITO SANTO":"ES","ESPIRITO SANTO":"ES","GOI√ÅS":"GO","GOIAS":"GO",
    "MARANH√ÉO":"MA","MARANHAO":"MA","MATO GROSSO":"MT","MATO GROSSO DO SUL":"MS","MINAS GERAIS":"MG",
    "PAR√Å":"PA","PARA":"PA","PARA√çBA":"PB","PARAIBA":"PB","PARAN√Å":"PR","PARANA":"PR",
    "PERNAMBUCO":"PE","PIAU√ç":"PI","PIAUI":"PI","RIO DE JANEIRO":"RJ","RIO GRANDE DO NORTE":"RN",
    "RIO GRANDE DO SUL":"RS","ROND√îNIA":"RO","RONDONIA":"RO","RORAIMA":"RR","SANTA CATARINA":"SC",
    "S√ÉO PAULO":"SP","SAO PAULO":"SP","SERGIPE":"SE","TOCANTINS":"TO"
  };

  function norm(s){
    return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toUpperCase().trim();
  }

  function onlyUF(value){
    const v = norm(value);
    if(!v) return '';
    // Se for exatamente 2 letras, aceita.
    if(/^[A-Z]{2}$/.test(v)) return v;
    // Se for nome do estado, mapeia.
    if(UF_MAP[v]) return UF_MAP[v];
    // Caso contr√°rio, descarta (evita "1100¬∫C", etc.)
    return '';
  }

  function normalizeHeader(h){
    return (h || '').toString().trim()
      .replace(/\s+/g,' ')
      .replace(/^CIDADE\s*$/i,'Cidade')
      .replace(/^UF\s*$/i,'UF')
      .replace(/^NOME\s*$/i,'Nome')
      .replace(/^TELEFONE\s*$/i,'Telefone')
      .replace(/^ENDERE√áO\s*$/i,'Endereco')
      .replace(/^INSTAGRAM\s*$/i,'Instagram')
      .replace(/^QUEIMA\s*$/i,'Queima')
      .replace(/^TEMPERATURA\s*$/i,'Temperatura')
      .replace(/^Qual seu nome\?$/i,'Contato')
      .replace(/^Voc√™ tamb√©m vende materiais, como argila, esmaltes, etc\?$/i,'Materiais');
  }

  function csvToRows(csvText){
    const lines = csvText.replace(/\r/g,'').split('\n').filter(l => l.trim().length);
    const out = [];
    let headers = [];
    function splitCSV(line){
      const res = []; let cur = '', inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i], nx = line[i+1];
        if(ch === '"'){ if(inQ && nx === '"'){ cur += '"'; i++; } else inQ = !inQ; }
        else if(ch === ',' && !inQ){ res.push(cur); cur=''; }
        else cur += ch;
      }
      res.push(cur); return res;
    }
    lines.forEach((line, idx) => {
      const cols = splitCSV(line).map(s => s.trim());
      if(idx === 0) headers = cols.map(normalizeHeader);
      else {
        const obj = {}
        headers.forEach((h,i)=> {
          const v = (cols[i] ?? '').trim();
          if(h && !/^Unnamed/i.test(h)) obj[h] = v;
        });
        out.push(obj);
      }
    });
    return out;
  }

  function uniqueSorted(list){
    return Array.from(new Set(list.filter(Boolean))).sort((a,b)=> a.localeCompare(b,'pt-BR'));
  }

  function buildUFOptions(){
    const ufs = uniqueSorted(rows.map(r => onlyUF(r.UF)).filter(Boolean));
    document.getElementById('uf').innerHTML = '<option value="">Todos</option>' + ufs.map(u=>`<option value="${u}">${u}</option>`).join('');
  }

  function buildCityOptions(){
    const uf = $uf.value;
    const cities = uniqueSorted(
      rows
        .filter(r => !uf || onlyUF(r.UF) === uf)
        .map(r => (r.Cidade || '').trim())
        .filter(Boolean)
    );
    $city.innerHTML = '<option value="">Todas</option>' + cities.map(c=>`<option value="${c}">${c}</option>`).join('');
    $city.disabled = false;
  }

  function textMatch(haystack, needle){
    return haystack.toLocaleLowerCase('pt-BR').includes(needle.toLocaleLowerCase('pt-BR'));
  }

  function applyFilters(){
    const uf = $uf.value.trim();
    const city = $city.value.trim();
    const q = $q.value.trim();

    filtered = rows.filter(r => {
      const rUF = onlyUF(r.UF);
      const rCity = (r.Cidade || '').trim();
      if(uf && rUF !== uf) return false;
      if(city && rCity !== city) return false;

      if(q){
        const blob = [
          r.Nome, r.Contato, r.Telefone,
          r.Endereco, r.Cidade, r.UF,
          r.Instagram, r.Queima, r.Temperatura, r.Materiais
        ].filter(Boolean).join(' | ');
        if(!textMatch(blob, q)) return false;
      }
      return true;
    });

    renderTable();
  }

  function safeLink(url, label){
    if(!url) return '';
    let href = url.trim();
    if(href && !/^https?:\/\//i.test(href)) href = 'https://' + href;
    const nice = label || href.replace(/^https?:\/\//i,'').replace(/\/$/,'');
    return `<a class="badgelink" href="${href}" target="_blank" rel="noopener">${nice}</a>`;
  }

  function renderTable(){
    $summary.textContent = `${filtered.length} resultado(s) de ${rows.length}`;
    $tbody.innerHTML = filtered.map(r => {
      const nome = r.Nome || '(Sem nome)';
      const uf = onlyUF(r.UF);
      const cidade = r.Cidade || '';
      const contatoTxt = [
        r.Contato ? `üë§ ${r.Contato}` : '',
        r.Telefone ? `üìû ${r.Telefone}` : '',
        r.Endereco ? `üìç ${r.Endereco}` : ''
      ].filter(Boolean).join('<br>');
      const queima = [r.Queima, r.Temperatura].filter(Boolean).join(' ¬∑ ');
      const links = [ safeLink(r.Instagram, 'Instagram') ].filter(Boolean).join(' ');

      return `<tr>
        <td><strong>${nome}</strong></td>
        <td>${uf}</td>
        <td>${cidade}</td>
        <td>${contatoTxt || '<span class="muted">‚Äî</span>'}</td>
        <td>${queima || '<span class="muted">‚Äî</span>'}</td>
        <td class="row">${links || '<span class="muted">‚Äî</span>'}</td>
      </tr>`;
    }).join('');
  }

  async function load(){
    try{
      const resp = await fetch(DATA_URL, {cache:'no-store'});
      if(!resp.ok) throw new Error(`Falha ao carregar dados (${resp.status})`);
      const text = await resp.text();
      rows = csvToRows(text).map(r => {
        const o = {};
        for(const k in r){
          const v = (r[k] ?? '').toString().trim();
          o[k] = (v.toLowerCase() === 'nan') ? '' : v;
        }
        // normaliza UF agora
        o.UF = onlyUF(o.UF);
        return o;
      });

      if(!rows.length){
        $summary.textContent = 'Sem dados para exibir. Confira o CSV.';
        return;
      }

      buildUFOptions();
      buildCityOptions();
      filtered = rows.slice();
      renderTable();
    }catch(err){
      console.error(err);
      $summary.textContent = 'Erro ao carregar os dados. Verifique a URL/permissaÃÉo do CSV.';
    }
  }

  $uf.addEventListener('change', () => { buildCityOptions(); applyFilters(); });
  $city.addEventListener('change', applyFilters);
  $q.addEventListener('input', () => { clearTimeout($q._t); $q._t = setTimeout(applyFilters, 150); });
  $clear.addEventListener('click', () => { $uf.value=''; buildCityOptions(); $city.value=''; $q.value=''; applyFilters(); });

  load();
})();
</script>
</body>
</html>
